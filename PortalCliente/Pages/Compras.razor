@page "/compras"
@using MudBlazor
@using System.Net.Http.Json
@inject HttpClient Http

<MudPaper Class="pa-0" Elevation="0">
	<MudTable Items="filteredCompras" Dense="true" Hover="true">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Mis compras</MudText>
            <MudSpacer />
			<div>
				<MudTextField Placeholder="Buscar por id o estado" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" @bind-Value="search" Style="width:320px" />
			</div>
        </ToolBarContent>
		<HeaderContent>
			<MudTh>Id</MudTh>
			<MudTh>Precio</MudTh>
			<MudTh>Estado</MudTh>
			<MudTh>Acciones</MudTh>
		</HeaderContent>
		<RowTemplate>
			<MudTd DataLabel="Id">@context.Id</MudTd>
			<MudTd DataLabel="Precio">$@context.Precio.ToString("N2")</MudTd>
			<MudTd DataLabel="Estado">
				@if (context.Estado == "Entregada")
				{
					<MudChip T="string" Color="Color.Success" Size="Size.Small">@context.Estado</MudChip>
				}
				else if (context.Estado == "Devuelta")
				{
					<MudChip T="string" Color="Color.Warning" Size="Size.Small">@context.Estado</MudChip>
				}
				else
				{
					<MudChip T="string" Color="Color.Info" Size="Size.Small">@context.Estado</MudChip>
				}
			</MudTd>
			<MudTd DataLabel="Acciones">
				<MudIconButton Icon="Icons.Material.Filled.Visibility" Color="Color.Default" Size="Size.Small" />
			</MudTd>
		</RowTemplate>
		<PagerContent>
			<MudTablePager PageSizeOptions="new int[] {5,10,20}" />
		</PagerContent>
	</MudTable>
</MudPaper>

@code {
	private string search = string.Empty;

	private class Compra
	{
		public string Id { get; set; } = string.Empty;
		public decimal Precio { get; set; }
		public string Estado { get; set; } = string.Empty;
	}

	private class ComprasData
	{
		public List<Compra> Compras { get; set; } = new List<Compra>();
	}

	private List<Compra> compras = new List<Compra>();

	private IEnumerable<Compra> filteredCompras => compras
		.Where(c => string.IsNullOrWhiteSpace(search)
			|| c.Id.Contains(search, StringComparison.OrdinalIgnoreCase)
			|| c.Estado.Contains(search, StringComparison.OrdinalIgnoreCase));

	protected override async Task OnInitializedAsync()
	{
		try
		{
			var data = await Http.GetFromJsonAsync<ComprasData>("compras");
			if (data?.Compras != null)
			{
				compras = data.Compras;
			}
		}
		catch
		{
			// ignore errors for now (could log or show message)
			compras = new List<Compra>();
		}
	}
}
